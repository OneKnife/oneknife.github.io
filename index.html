<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Hexo, NexT">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2">






<meta property="og:type" content="website">
<meta property="og:title" content="YSir&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="YSir&#39;s Blog">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="YSir&#39;s Blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/">





  <title>YSir's Blog</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">YSir's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/23/正则表达式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ysir">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YSir's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/23/正则表达式/" itemprop="url">正则表达式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-23T16:22:06+08:00">
                2020-03-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h1><blockquote>
<p>正则表达式（Regular Expression）是计算机科学的一个概念。正则表达式使用单个字符串来描述、匹配一系列符合某个句法规则的字符串。在很多文本编辑器里，正则表达式通常被用来检索、替换那些符合某个模式的文本。</p>
</blockquote>
<h2 id="符号"><a href="#符号" class="headerlink" title="符号"></a>符号</h2><p>正则表达式由一些普通字符和一些元字符（metacharacters）组成。普通字符包括大小写的字母和数字，而元字符则具有特殊的含义</p>
<p>在最简单的情况下，一个正则表达式看上去就是一个普通的查找串。例如，正则表达式”testing”中没有包含任何元字符，它可以匹配”testing”和”testing123”等字符串，但是不能匹配”Testing”。</p>
<p>要想真正的用好正则表达式，正确的理解元字符是最重要的事情。下面列出了所有的元字符和对它们的一个简短的描述。</p>
<table>
<thead>
<tr>
<th>元字符</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>\</td>
<td>转义字符</td>
</tr>
<tr>
<td>^</td>
<td>匹配输入字行首。如果设置了RegExp对象的Multiline属性，^也匹配“\n”或“\r”之后的位置。</td>
</tr>
<tr>
<td>$</td>
<td>匹配输入行尾。如果设置了RegExp对象的Multiline属性，$也匹配“\n”或“\r”之前的位置。</td>
</tr>
<tr>
<td>*</td>
<td>匹配前面的子表达式任意次。例如，zo<em>能匹配“z”，也能匹配“zo”以及“zoo”。</em>等价于{0,}。</td>
</tr>
<tr>
<td>+</td>
<td>匹配前面的子表达式一次或多次(大于等于1次）。例如，“zo+”能匹配“zo”以及“zoo”，但不能匹配“z”。+等价于{1,}。</td>
</tr>
<tr>
<td>?</td>
<td>匹配前面的子表达式零次或一次。例如，“do(es)?”可以匹配“do”或“does”。?等价于{0,1}。</td>
</tr>
<tr>
<td>{<em>n</em>}</td>
<td><em>n</em>是一个非负整数。匹配确定的<em>n</em>次。例如，“o{2}”不能匹配“Bob”中的“o”，但是能匹配“food”中的两个o。</td>
</tr>
<tr>
<td>{<em>n</em>,}</td>
<td><em>n</em>是一个非负整数。至少匹配<em>n</em>次。例如，“o{2,}”不能匹配“Bob”中的“o”，但能匹配“foooood”中的所有o。“o{1,}”等价于“o+”。“o{0,}”则等价于“o*”。</td>
</tr>
<tr>
<td>{<em>n</em>,<em>m</em>}</td>
<td><em>m</em>和<em>n</em>均为非负整数，其中<em>n</em>&lt;=<em>m</em>。最少匹配<em>n</em>次且最多匹配<em>m</em>次。例如，“o{1,3}”将匹配“fooooood”中的前三个o为一组，后三个o为一组。“o{0,1}”等价于“o?”。请注意在逗号和两个数之间不能有空格。</td>
</tr>
<tr>
<td>?</td>
<td>当该字符紧跟在任何一个其他限制符（<em>,+,?，{</em>n<em>}，{</em>n<em>,}，{</em>n<em>,</em>m*}）后面时，匹配模式是非贪婪的。非贪婪模式尽可能少地匹配所搜索的字符串，而默认的贪婪模式则尽可能多地匹配所搜索的字符串。例如，对于字符串“oooo”，“o+”将尽可能多地匹配“o”，得到结果[“oooo”]，而“o+?”将尽可能少地匹配“o”，得到结果 [‘o’, ‘o’, ‘o’, ‘o’]</td>
</tr>
<tr>
<td>.点</td>
<td>匹配除“\n”和”\r”之外的任何单个字符。要匹配包括“\n”和”\r”在内的任何字符，请使用像“[\s\S]”的模式。</td>
</tr>
<tr>
<td>x丨y</td>
<td>匹配x或y。例如，“z丨food”能匹配“z”或“food”(此处请谨慎)。“[z丨f]ood”则匹配“zood”或“food”。</td>
</tr>
<tr>
<td>[xyz]</td>
<td>字符集合。匹配所包含的任意一个字符。例如，“[abc]”可以匹配“plain”中的“a”。</td>
</tr>
<tr>
<td>[^xyz]</td>
<td>负值字符集合。匹配未包含的任意字符。例如，“[^abc]”可以匹配“plain”中的“plin”任一字符。</td>
</tr>
<tr>
<td>[a-z]</td>
<td>字符范围。匹配指定范围内的任意字符。例如，“[a-z]”可以匹配“a”到“z”范围内的任意小写字母字符。注意:只有连字符在字符组内部时,并且出现在两个字符之间时,才能表示字符的范围; 如果出字符组的开头,则只能表示连字符本身.</td>
</tr>
<tr>
<td>[^a-z]</td>
<td>负值字符范围。匹配任何不在指定范围内的任意字符。例如，“[^a-z]”可以匹配任何不在“a”到“z”范围内的任意字符。</td>
</tr>
<tr>
<td>\b</td>
<td>匹配一个单词的边界，也就是指单词和空格间的位置（即正则表达式的“匹配”有两种概念，一种是匹配字符，一种是匹配位置，这里的\b就是匹配位置的）。例如，“er\b”可以匹配“never”中的“er”，但不能匹配“verb”中的“er”；“\b1_”可以匹配“1_23”中的“1_”，但不能匹配“21_3”中的“1_”。</td>
</tr>
<tr>
<td>\B</td>
<td>匹配非单词边界。“er\B”能匹配“verb”中的“er”，但不能匹配“never”中的“er”。</td>
</tr>
<tr>
<td>\cx</td>
<td>匹配由x指明的控制字符。例如，\cM匹配一个Control-M或回车符。x的值必须为A-Z或a-z之一。否则，将c视为一个原义的“c”字符。</td>
</tr>
<tr>
<td>\d</td>
<td>匹配数字字符[0-9]。</td>
</tr>
<tr>
<td>\D</td>
<td>匹配一个非数字字符。等价于[^0-9]。</td>
</tr>
<tr>
<td>\f</td>
<td>匹配一个换页符。等价于\x0c和\cL。</td>
</tr>
<tr>
<td>\n</td>
<td>匹配一个换行符。等价于\x0a和\cJ。</td>
</tr>
<tr>
<td>\r</td>
<td>匹配一个回车符。等价于\x0d和\cM。</td>
</tr>
<tr>
<td>\s</td>
<td>匹配任何不可见字符，包括空格、制表符、换页符等等。等价于[ \f\n\r\t\v]。</td>
</tr>
<tr>
<td>\S</td>
<td>匹配任何可见字符。等价于[^ \f\n\r\t\v]。</td>
</tr>
<tr>
<td>\t</td>
<td>匹配一个制表符。等价于\x09和\cI。</td>
</tr>
<tr>
<td>\v</td>
<td>匹配一个垂直制表符。等价于\x0b和\cK。</td>
</tr>
<tr>
<td>\w</td>
<td>匹配包括下划线的任何单词字符。类似但不等价于“[A-Za-z0-9_]”，这里的”单词”字符使用Unicode字符集。</td>
</tr>
<tr>
<td>\W</td>
<td>匹配任何非单词字符。等价于“[^A-Za-z0-9_]”。</td>
</tr>
<tr>
<td>\x<em>n</em></td>
<td>匹配<em>n</em>，其中<em>n</em>为十六进制转义值。十六进制转义值必须为确定的两个数字长。例如，“\x41”匹配“A”。“\x041”则等价于“\x04&amp;1”。正则表达式中可以使用ASCII编码。</td>
</tr>
<tr>
<td>*num*</td>
<td>匹配<em>num</em>，其中<em>num</em>是一个正整数。对所获取的匹配的引用。例如，“(.)\1”匹配两个连续的相同字符。</td>
</tr>
<tr>
<td>*n*</td>
<td>标识一个八进制转义值或一个向后引用。如果*n<em>之前至少</em>n<em>个获取的子表达式，则</em>n<em>为向后引用。否则，如果</em>n<em>为八进制数字（0-7），则</em>n*为一个八进制转义值。</td>
</tr>
<tr>
<td>*nm*</td>
<td>标识一个八进制转义值或一个向后引用。如果*nm<em>之前至少有</em>nm<em>个获得子表达式，则</em>nm<em>为向后引用。如果\</em>nm<em>之前至少有</em>n<em>个获取，则</em>n<em>为一个后跟文字</em>m<em>的向后引用。如果前面的条件都不满足，若</em>n<em>和</em>m<em>均为八进制数字（0-7），则\</em>nm<em>将匹配八进制转义值</em>nm*。</td>
</tr>
<tr>
<td>*nml*</td>
<td>如果<em>n</em>为八进制数字（0-7），且<em>m</em>和<em>l</em>均为八进制数字（0-7），则匹配八进制转义值<em>nml</em>。</td>
</tr>
<tr>
<td>\u<em>n</em></td>
<td>匹配<em>n</em>，其中<em>n</em>是一个用四个十六进制数字表示的Unicode字符。例如，\u00A9匹配版权符号（&copy;）。</td>
</tr>
<tr>
<td>\p{P}</td>
<td>小写 p 是 property 的意思，表示 Unicode 属性，用于 Unicode 正表达式的前缀。中括号内的“P”表示Unicode 字符集七个字符属性之一：标点字符。其他六个属性：L：字母；M：标记符号（一般不会单独出现）；Z：分隔符（比如空格、换行等）；S：符号（比如数学符号、货币符号等）；N：数字（比如阿拉伯数字、罗马数字等）；C：其他字符。*<em>注：此语法部分语言不支持，例：javascript。</em></td>
</tr>
<tr>
<td>\&lt;></td>
<td>匹配词（word）的开始（\&lt;）和结束（>）。例如正则表达式\&lt;the>能够匹配字符串”for the wise”中的”the”，但是不能匹配字符串”otherwise”中的”the”。注意：这个元字符不是所有的软件都支持的。</td>
</tr>
<tr>
<td>( )</td>
<td>将( 和 ) 之间的表达式定义为“组”（group），并且将匹配这个表达式的字符保存到一个临时区域（一个正则表达式中最多可以保存9个），它们可以用 \1 到\9 的符号来引用。</td>
</tr>
<tr>
<td>丨</td>
<td>将两个匹配条件进行逻辑“或”（or）运算。例如正则表达式(him丨her) 匹配”it belongs to him”和”it belongs to her”，但是不能匹配”it belongs to them.”。注意：这个元字符不是所有的软件都支持的。</td>
</tr>
</tbody>
</table>
<h3 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h3><p>在正则表达式中，如果直接给出字符，就是精确匹配。用<code>\d</code>可以匹配一个数字，<code>\w</code>可以匹配一个字母或数字，所以：</p>
<ul>
<li><code>&#39;00\d&#39;</code>可以匹配<code>&#39;007&#39;</code>，但无法匹配<code>&#39;00A&#39;</code>；</li>
<li><code>&#39;\d\d\d&#39;</code>可以匹配<code>&#39;010&#39;</code>；</li>
<li><code>&#39;\w\w&#39;</code>可以匹配<code>&#39;js&#39;</code>；</li>
</ul>
<p><code>.</code>可以匹配任意字符，所以：</p>
<ul>
<li><code>&#39;js.&#39;</code>可以匹配<code>&#39;jsp&#39;</code>、<code>&#39;jss&#39;</code>、<code>&#39;js!&#39;</code>等等。</li>
</ul>
<p>要匹配变长的字符，在正则表达式中，用<code>*</code>表示任意个字符（包括0个），用<code>+</code>表示至少一个字符，用<code>?</code>表示0个或1个字符，用<code>{n}</code>表示n个字符，用<code>{n,m}</code>表示n-m个字符：</p>
<p>来看一个复杂的例子：<code>\d{3}\s+\d{3,8}</code>。</p>
<p>我们来从左到右解读一下：</p>
<ol>
<li><code>\d{3}</code>表示匹配3个数字，例如<code>&#39;010&#39;</code>；</li>
<li><code>\s</code>可以匹配一个空格（也包括Tab等空白符），所以<code>\s+</code>表示至少有一个空格，例如匹配<code>&#39; &#39;</code>，<code>&#39;\t\t&#39;</code>等；</li>
<li><code>\d{3,8}</code>表示3-8个数字，例如<code>&#39;1234567&#39;</code>。</li>
</ol>
<p>综合起来，上面的正则表达式可以匹配以任意个空格隔开的带区号的电话号码。</p>
<p>如果要匹配<code>&#39;010-12345&#39;</code>这样的号码呢？由于<code>&#39;-&#39;</code>是特殊字符，在正则表达式中，要用<code>&#39;\&#39;</code>转义，所以，上面的正则是<code>\d{3}\-\d{3,8}</code>。</p>
<p>但是，仍然无法匹配<code>&#39;010 - 12345&#39;</code>，因为带有空格。所以我们需要更复杂的匹配方式。</p>
<h4 id="更复杂的例子"><a href="#更复杂的例子" class="headerlink" title="更复杂的例子"></a>更复杂的例子</h4><p>要做更精确地匹配，可以用<code>[]</code>表示范围，比如：</p>
<ul>
<li><code>[0-9a-zA-Z\_]</code>可以匹配一个数字、字母或者下划线；</li>
<li><code>[0-9a-zA-Z\_]+</code>可以匹配至少由一个数字、字母或者下划线组成的字符串，比如<code>&#39;a100&#39;</code>，<code>&#39;0_Z&#39;</code>，<code>&#39;js2015&#39;</code>等等；</li>
<li><code>[a-zA-Z\_\$][0-9a-zA-Z\_\$]*</code>可以匹配由字母或下划线、\$开头，后接任意个由一个数字、字母或者下划线、\$组成的字符串，也就是JavaScript允许的变量名；</li>
<li><code>[a-zA-Z\_\$][0-9a-zA-Z\_\$]{0, 19}</code>更精确地限制了变量的长度是1-20个字符（前面1个字符+后面最多19个字符）。</li>
</ul>
<p><code>A|B</code>可以匹配A或B，所以<code>(J|j)ava(S|s)cript</code>可以匹配<code>&#39;JavaScript&#39;</code>、<code>&#39;Javascript&#39;</code>、<code>&#39;javaScript&#39;</code>或者<code>&#39;javascript&#39;</code>。</p>
<p><code>^</code>表示行的开头，<code>^\d</code>表示必须以数字开头。</p>
<p><code>$</code>表示行的结束，<code>\d$</code>表示必须以数字结束。</p>
<p>你可能注意到了，<code>js</code>也可以匹配<code>&#39;jsp&#39;</code>，但是加上<code>^js$</code>就变成了整行匹配，就只能匹配<code>&#39;js&#39;</code>了。</p>
<h2 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h2><p>用js举例</p>
<ol>
<li><p>使用字面量<code>/正则表达式/</code></p>
<p><code>var regex = /abc/</code></p>
</li>
<li><p>使用<code>new RegExp(&#39;正则表达式&#39;)</code></p>
</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> re1 = <span class="regexp">/ABC\-001/</span>;</span><br><span class="line"><span class="keyword">var</span> re2 = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">'ABC\\-001'</span>);</span><br><span class="line"></span><br><span class="line">re1; <span class="comment">// /ABC\-001/</span></span><br><span class="line">re2; <span class="comment">// /ABC\-001/</span></span><br></pre></td></tr></table></figure>
<p>注意，如果使用第二种写法，因为字符串的转义问题，字符串的两个<code>\\</code>实际上是一个<code>\</code>。</p>
<p>###判断正则表达式是否匹配</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var re = /^\d&#123;3&#125;\-\d&#123;3,8&#125;$/;</span><br><span class="line">re.test(&apos;010-12345&apos;); // true</span><br><span class="line">re.test(&apos;010-1234x&apos;); // false</span><br><span class="line">re.test(&apos;010 12345&apos;); // false</span><br></pre></td></tr></table></figure>
<p>RegExp对象的<code>test()</code>方法用于测试给定的字符串是否符合条件。</p>
<h3 id="切分字符串"><a href="#切分字符串" class="headerlink" title="切分字符串"></a>切分字符串</h3><p>用正则表达式切分字符串比用固定的字符更灵活，正常的切分代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&apos;a b   c&apos;.split(&apos; &apos;); // [&apos;a&apos;, &apos;b&apos;, &apos;&apos;, &apos;&apos;, &apos;c&apos;]</span><br></pre></td></tr></table></figure>
<p>正则表达式：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 切割连续空格分隔</span></span><br><span class="line"><span class="string">'a b   c'</span>.split(<span class="regexp">/\s+/</span>); <span class="comment">// ['a', 'b', 'c']</span></span><br><span class="line"><span class="comment">// 可分隔空格和,</span></span><br><span class="line"><span class="string">'a,b, c  d'</span>.split(<span class="regexp">/[\s\,]+/</span>); <span class="comment">// ['a', 'b', 'c', 'd']</span></span><br><span class="line"><span class="comment">// 分隔空格 , ;</span></span><br><span class="line"><span class="string">'a,b;; c  d'</span>.split(<span class="regexp">/[\s\,\;]+/</span>); <span class="comment">// ['a', 'b', 'c', 'd']</span></span><br></pre></td></tr></table></figure>
<h3 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h3><p>除了简单地判断是否匹配之外，正则表达式还有提取子串的强大功能。用<code>()</code>表示的就是要提取的分组（Group）。比如：</p>
<p><code>^(\d{3})-(\d{3,8})$</code>分别定义了两个组，可以直接从匹配的字符串中提取出区号和本地号码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> re = <span class="regexp">/^(\d&#123;3&#125;)-(\d&#123;3,8&#125;)$/</span>;</span><br><span class="line">re.exec(<span class="string">'010-12345'</span>); <span class="comment">// ['010-12345', '010', '12345']</span></span><br><span class="line">re.exec(<span class="string">'010 12345'</span>); <span class="comment">// null</span></span><br></pre></td></tr></table></figure>
<p>如果正则表达式中定义了组，就可以在<code>RegExp</code>对象上用<code>exec()</code>方法提取出子串来。</p>
<p><code>exec()</code>方法在匹配成功后，会返回一个<code>Array</code>，第一个元素是正则表达式匹配到的整个字符串，后面的字符串表示匹配成功的子串。</p>
<p><code>exec()</code>方法在匹配失败时返回<code>null</code>。</p>
<p><strong>提取子串的例子：</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> re = <span class="regexp">/^(0[0-9]|1[0-9]|2[0-3]|[0-9])\:(0[0-9]|1[0-9]|2[0-9]|3[0-9]|4[0-9]|5[0-9]|[0-9])\:(0[0-9]|1[0-9]|2[0-9]|3[0-9]|4[0-9]|5[0-9]|[0-9])$/</span>;</span><br><span class="line">re.exec(<span class="string">'19:05:30'</span>); <span class="comment">// ['19:05:30', '19', '05', '30']</span></span><br></pre></td></tr></table></figure>
<p>这个正则表达式可以直接识别合法的时间。但是有些时候，用正则表达式也无法做到完全验证，比如识别日期：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> re = <span class="regexp">/^(0[1-9]|1[0-2]|[0-9])-(0[1-9]|1[0-9]|2[0-9]|3[0-1]|[0-9])$/</span>;</span><br></pre></td></tr></table></figure>
<p>对于<code>&#39;2-30&#39;</code>，<code>&#39;4-31&#39;</code>这样的非法日期，用正则还是识别不了，或者说写出来非常困难，这时就需要程序配合识别了。</p>
<h3 id="贪婪匹配"><a href="#贪婪匹配" class="headerlink" title="贪婪匹配"></a>贪婪匹配</h3><p>需要特别指出的是，正则匹配默认是贪婪匹配，也就是匹配尽可能多的字符。举例如下，匹配出数字后面的<code>0</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> re = <span class="regexp">/^(\d+)(0*)$/</span>;</span><br><span class="line">re.exec(<span class="string">'102300'</span>); <span class="comment">// ['102300', '102300', '']</span></span><br></pre></td></tr></table></figure>
<p>由于<code>\d+</code>采用贪婪匹配，直接把后面的<code>0</code>全部匹配了，结果<code>0*</code>只能匹配空字符串了。</p>
<p>必须让<code>\d+</code>采用非贪婪匹配（也就是尽可能少匹配），才能把后面的<code>0</code>匹配出来，加个<code>?</code>就可以让<code>\d+</code>采用非贪婪匹配：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> re = <span class="regexp">/^(\d+?)(0*)$/</span>;</span><br><span class="line">re.exec(<span class="string">'102300'</span>); <span class="comment">// ['102300', '1023', '00']</span></span><br></pre></td></tr></table></figure>
<h3 id="全局搜索"><a href="#全局搜索" class="headerlink" title="全局搜索"></a>全局搜索</h3><p>JavaScript的正则表达式还有几个特殊的标志，最常用的是<code>g</code>，表示全局匹配：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> r1 = <span class="regexp">/test/g</span>;</span><br><span class="line"><span class="comment">// 等价于:</span></span><br><span class="line"><span class="keyword">var</span> r2 = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">'test'</span>, <span class="string">'g'</span>);</span><br></pre></td></tr></table></figure>
<p>全局匹配可以多次执行<code>exec()</code>方法来搜索一个匹配的字符串。当我们指定<code>g</code>标志后，每次运行<code>exec()</code>，正则表达式本身会更新<code>lastIndex</code>属性，表示上次匹配到的最后索引：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> s = <span class="string">'JavaScript, VBScript, JScript and ECMAScript'</span>;</span><br><span class="line"><span class="keyword">var</span> re=<span class="regexp">/[a-zA-Z]+Script/g</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用全局匹配:</span></span><br><span class="line">re.exec(s); <span class="comment">// ['JavaScript']</span></span><br><span class="line">re.lastIndex; <span class="comment">// 10</span></span><br><span class="line"></span><br><span class="line">re.exec(s); <span class="comment">// ['VBScript']</span></span><br><span class="line">re.lastIndex; <span class="comment">// 20</span></span><br><span class="line"></span><br><span class="line">re.exec(s); <span class="comment">// ['JScript']</span></span><br><span class="line">re.lastIndex; <span class="comment">// 29</span></span><br><span class="line"></span><br><span class="line">re.exec(s); <span class="comment">// ['ECMAScript']</span></span><br><span class="line">re.lastIndex; <span class="comment">// 44</span></span><br><span class="line"></span><br><span class="line">re.exec(s); <span class="comment">// null，直到结束仍没有匹配到</span></span><br></pre></td></tr></table></figure>
<p>全局匹配类似搜索，因此不能使用<code>/^...$/</code>，那样只会最多匹配一次。</p>
<p>正则表达式还可以指定<code>i</code>标志，表示忽略大小写，<code>m</code>标志，表示执行多行匹配。</p>
<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><p>js中replace替换对应的字符串 <strong>stringObject.replace(regexp/substr,replacement)</strong></p>
<p><em>replacement</em> 可以是字符串，也可以是函数。</p>
<p><strong>当需要替换的字符串是正则表达式的时候</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> str = <span class="string">'10.00,22,20.11'</span>;</span><br><span class="line">str = str.replace(<span class="regexp">/\d+(\.\d+)?/</span>,<span class="string">'$10.00'</span>); </span><br><span class="line"><span class="comment">//  /\d+(\.\d+)?/  这个正则表达式是表示带小数的数字，例如：10.00</span></span><br><span class="line"><span class="comment">//中文货币符号替换成美元货币符号</span></span><br><span class="line"><span class="built_in">console</span>.log(str);  <span class="comment">//  .000.00,22,20.11</span></span><br></pre></td></tr></table></figure>
<p>这个时候发现，replace把10.00替换成$10.00的时候，却变成了 .000.00</p>
<p>原因是因为 $1 是切割正则表达式的第一个括号 (.\d+)，所以就分成了两步</p>
<p>第一步：(/.\d+/) = ‘$1’   ===&gt;   $1 = ‘.00’</p>
<p>第二步：’$10.00’ = ‘$1’ + ‘0.00’  ===&gt; str = .000.00</p>
<p>解决这个问题就可以用下面这个当replacement是函数的方法，返回 function 的时候就没有 $1 对正则表达式的括号进行切割了。</p>
<p><strong>3、当replacement是函数的时候</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> str = <span class="string">'10.00,22,20.11'</span>;</span><br><span class="line">str = str.replace(<span class="regexp">/\d+(\.\d+)?/</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'$10.00'</span>;</span><br><span class="line">&#125;); </span><br><span class="line"><span class="built_in">console</span>.log(str);  <span class="comment">//  $10.00,22,20.11</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/15/KVC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ysir">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YSir's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/15/KVC/" itemprop="url">KVC</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-15T15:48:14+08:00">
                2020-03-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="KVC"><a href="#KVC" class="headerlink" title="KVC"></a>KVC</h1><p>KVC的全称是Key-Value Coding，俗称“键值编码”，可以通过一个key来访问属性</p>
<h3 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 常用api</span><br><span class="line">- (void)setValue:(id)value forKeyPath:(NSString *)keyPath;</span><br><span class="line">- (void)setValue:(id)value forKey:(NSString *)key;</span><br><span class="line">- (void)valueForKeyPath:(NSString)keyPath;</span><br><span class="line">- (void)valueForKey:(NSString)key;</span><br></pre></td></tr></table></figure>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><h4 id="赋值过程"><a href="#赋值过程" class="headerlink" title="赋值过程"></a>赋值过程</h4><ol>
<li><p>按照<strong><em>setKey</em></strong>、 <strong><em>_setKey</em></strong>的顺序查找set方法</p>
</li>
<li><p>如果没有找到set方法，则会判断<strong><em>accessInstanceVariablesDirectly</em></strong>方法的返回值，如果返回值为<strong><em>YES</em></strong>则按照<strong><em>_key</em></strong>、<strong><em>_isKey</em></strong>、<strong><em>key</em></strong>、<strong><em>isKey</em></strong>的顺序查找成员变量</p>
</li>
</ol>
<blockquote>
<p>无论KVC有没有调用set方法(对象内部有没有set方法)，KVC都会触发KVO(在KVC内部会调用<em>willChangeValueForKey</em>和<em>didChangeValueForKey</em>,在didChangeValueForKey内部会触发监听方法)。</p>
</blockquote>
<h4 id="取值过程"><a href="#取值过程" class="headerlink" title="取值过程"></a>取值过程</h4><ol>
<li>按照<strong><em>getKey</em></strong>、 <strong><em>key</em></strong>、 <strong><em>isKey</em></strong>、 <strong><em>_key</em></strong>的顺序查找get方法</li>
<li>如果没有找到get方法，则会判断<strong><em>accessInstanceVariablesDirectly</em></strong>方法的返回值，如果返回值为<strong>YES</strong>，则按照<strong><em>_key</em></strong>、<strong><em>_isKey</em></strong>、<strong><em>key</em></strong>、<strong><em>isKey</em></strong>的顺序查找成员变量</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/15/KVO/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ysir">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YSir's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/15/KVO/" itemprop="url">KVO</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-15T14:31:48+08:00">
                2020-03-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="KVO"><a href="#KVO" class="headerlink" title="KVO"></a>KVO</h1><h3 id="什么是KVO"><a href="#什么是KVO" class="headerlink" title="什么是KVO"></a>什么是KVO</h3><p>KVO的全称是Key-Value Observing,俗称”键值监听”,可以用于监听某个对象属性值得改变</p>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 监听someObj的someKey</span><br><span class="line">NSKeyValueObservingOptions options = NSkeyValueObservingOptionNew | NSkeyValueObservingOptionOld;</span><br><span class="line">[someObj addObserver:self forKeyPath:@&quot;someKey&quot; options:options context:nil];</span><br><span class="line"></span><br><span class="line">// 当监听对象的属性值发生改变，就会调用</span><br><span class="line">- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary&lt;NSKeyValueChangeKey,id&gt; *)change context:(void *)context&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="本质"><a href="#本质" class="headerlink" title="本质"></a>本质</h3><p>KVO的本质是使用runtime动态生成一个<code>NSKVONotifying_XXXClass</code>的类，是原来类的子类。</p>
<p>在<code>NSKVONotifying_XXXClass</code>的set方法中的操作大致为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// 注：以下为伪代码</span><br><span class="line"></span><br><span class="line">- setSomeKey:(id)someKey &#123;</span><br><span class="line">	_NSSetIntValueAndNotify(); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Foundation框架中</span><br><span class="line">void _NSSetIntValueAndNotify() &#123;</span><br><span class="line">  [self willChangeValueForKey:@&quot;someKey&quot;];</span><br><span class="line">	[super setSomeKey: someKey];</span><br><span class="line">  [self. didChangeValueForKey:@&quot;someKey&quot;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)didChangeValueForKey:(NSString *)key &#123;</span><br><span class="line">  // 通知监听器</span><br><span class="line">  [oberser observeValueForKeyPath:key ofObject: self, change: nil, context:nil];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h3><ul>
<li>如何手动触发监听器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[someObject willChangeValueForKey:@&quot;someKey&quot;];</span><br><span class="line">[someObject didChangeValueForKey:@&quot;someKey&quot;];</span><br></pre></td></tr></table></figure>
<ul>
<li><p>直接修改成员变量会触发KVO么？</p>
<p>不会，只有调用set方法才会调用KVO</p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/14/OC对象/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ysir">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YSir's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/14/OC对象/" itemprop="url">OC对象</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-14T21:13:48+08:00">
                2020-03-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="OC对象"><a href="#OC对象" class="headerlink" title="OC对象"></a>OC对象</h1><h3 id="OC对象分类"><a href="#OC对象分类" class="headerlink" title="OC对象分类"></a>OC对象分类</h3><ul>
<li>instance对象(实例对象)</li>
<li>class对象(类对象)</li>
<li>meta对象(元类对象)</li>
</ul>
<h3 id="对象的结构"><a href="#对象的结构" class="headerlink" title="对象的结构"></a>对象的结构</h3><ul>
<li>instance<ul>
<li>isa指针</li>
<li>其他成员变量</li>
</ul>
</li>
<li>class对象<ul>
<li>isa指针</li>
<li>superclass指针</li>
<li>类的属性信息 （@property）</li>
<li>类的对象方法信息 （instance method）</li>
<li>类的协议信息 (protocol)</li>
<li>类的成员变量信息(ivar)</li>
</ul>
</li>
<li>meta-class<ul>
<li>isa指针</li>
<li>superclass</li>
<li>类方法信息(class method)</li>
</ul>
</li>
</ul>
<h3 id="获取类对象"><a href="#获取类对象" class="headerlink" title="获取类对象"></a>获取类对象</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Class objectClass = [NSObject class]; // 获取类对象</span><br><span class="line">Class objectClass = object_getClass(object) // 获取类对象</span><br><span class="line">Class metaClass = object_getClass(objectClass) // object_getClass 传类对象获取元类对象</span><br><span class="line">BOOL result = class_isMetaClass([NSObject class]) //判断是否是元类对象</span><br></pre></td></tr></table></figure>
<h3 id="isa指针和superclass"><a href="#isa指针和superclass" class="headerlink" title="isa指针和superclass"></a>isa指针和superclass</h3><ul>
<li>instance的isa指向class</li>
<li>class的isa指向meta-class</li>
<li>meta-class的isa指向基类的meta-class</li>
<li><p>class的superclass指向父类的class</p>
<blockquote>
<p>如果没有父类，superclass指针为nil</p>
</blockquote>
</li>
<li><p>meta-class的superclass指向父类的meta-class</p>
<blockquote>
<p>基类的meta-class的superclass指向基类的class</p>
</blockquote>
</li>
<li><p>instance调用对象方法的轨迹</p>
<blockquote>
<p>isa找到class，方法不存在，就通过superclass找父类</p>
</blockquote>
</li>
<li><p>class调用类方法的轨迹</p>
<blockquote>
<p>isa找meta-class，方法不存在，就通过superclass找父类</p>
</blockquote>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/14/iOS底层原理笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ysir">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YSir's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/14/iOS底层原理笔记/" itemprop="url">iOS底层原理笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-14T17:13:31+08:00">
                2020-03-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="iOS底层原理笔记"><a href="#iOS底层原理笔记" class="headerlink" title="iOS底层原理笔记"></a>iOS底层原理笔记</h1><h3 id="端口映射"><a href="#端口映射" class="headerlink" title="端口映射"></a>端口映射</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python tcprelay.py -t 22:10010 // usbmuxd将本地10010端口tcp协议 通过usb转发到iPhone的22端口</span><br></pre></td></tr></table></figure>
<h3 id="Cycript-安装和使用"><a href="#Cycript-安装和使用" class="headerlink" title="Cycript 安装和使用"></a>Cycript 安装和使用</h3><p>安装源：<a href="http://apt.saurik.com/cydia" target="_blank" rel="noopener">apt.saurik.com/cydia</a></p>
<p>iOS11及以上iOS版本中不能直接使用Cycript,如果想继续使用可使用以下方法</p>
<ol>
<li><p>ssh登录iPhone</p>
</li>
<li><p>执行以下命令(如没有安装wget，在Cydia安装)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">wget [http://apt.saurik.com/debs/cycript_0.9.594_iphoneos-arm.deb ](https://links.jianshu.com/go?to=http%3A%2F%2Fapt.saurik.com%2Fdebs%2Fcycript_0.9.594_iphoneos-arm.deb)</span><br><span class="line"></span><br><span class="line">wget [http://www.tateu.net/repo/files/net.tateu.cycriptlistenertweak_1.0.0_iphoneos-arm.deb ](https://links.jianshu.com/go?to=http%3A%2F%2Fwww.tateu.net%2Frepo%2Ffiles%2Fnet.tateu.cycriptlistenertweak_1.0.0_iphoneos-arm.deb)</span><br><span class="line"></span><br><span class="line">wget [http://www.tateu.net/repo/files/net.tateu.cyrun_1.0.5_iphoneos-arm.deb](https://links.jianshu.com/go?to=http%3A%2F%2Fwww.tateu.net%2Frepo%2Ffiles%2Fnet.tateu.cyrun_1.0.5_iphoneos-arm.deb)</span><br><span class="line"></span><br><span class="line">dpkg -i cycript_0.9.594_iphoneos-arm.deb</span><br><span class="line"></span><br><span class="line">dpkg -i net.tateu.cycriptlistenertweak_1.0.0_iphoneos-arm.deb net.tateu.cyrun_1.0.5_iphoneos-arm.deb</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过cyrun进入cycript</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cyrun -n SpringBoard -e </span><br><span class="line">// -n表示SpringBoard为进程名字，-e表示使cycript能注入到SpringBoard进程中</span><br></pre></td></tr></table></figure>
</li>
<li><p>退出cycirpt</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.  control 加 D，退出cycript</span><br><span class="line">2. 执行 cyrun -n SpringBoard -d,将cycript从之前的进程中抽离出来，才能将cycript注入另一个进程噢。</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="Cycript使用"><a href="#Cycript使用" class="headerlink" title="Cycript使用"></a>Cycript使用</h3><p>打印view层级数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[UIApp.keyWindow recursiveDescription]</span><br><span class="line">[UIApp.keyWindow recursiveDescription].toString() //排版更清楚</span><br><span class="line">UIApp.keyWindow recursiveDescription().toString() // 也可这么写</span><br></pre></td></tr></table></figure>
<p>筛选</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">choose(UIViewController)</span><br></pre></td></tr></table></figure>
<p>查看对象的缩影成员变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*对象</span><br></pre></td></tr></table></figure>
<p>编译</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">clang test.c // 编译c语言文件为可执行文件</span><br><span class="line">clang -o test2 test.c // test2 为编译后可执行文件名</span><br><span class="line">clang -c test.c// 只编译成.o文件不链接</span><br></pre></td></tr></table></figure>
<p>查看文件信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file Test</span><br></pre></td></tr></table></figure>
<p>查看可执行文件支持架构</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lipo -info Test</span><br></pre></td></tr></table></figure>
<p>拆分二进制文件架构</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lipo Test -thin armv7 -output Test_armv7</span><br></pre></td></tr></table></figure>
<p>合并二进制文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lipo -create Test_arm64 Test_armv7 -output Test2</span><br></pre></td></tr></table></figure>
<p>Mach-O基本结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Header</span><br><span class="line">- 文件类型，目标架构等</span><br><span class="line">Load Commands</span><br><span class="line">- 描述文件在虚拟内存中的逻辑结构、布局</span><br><span class="line">Raw segment data </span><br><span class="line">- 在Load commands中定义的Segment的原始数据</span><br></pre></td></tr></table></figure>
<p>验证可执行文件是否被加壳</p>
<ul>
<li><p>使用MachOView 查看Load Commands 中LC——ENCRYPTING_INFO 中 Crypt_ID 是否为0  // 0未加密</p>
</li>
<li><p>otool -l Test | grep Crypt  //  cryptid 为0 则未加密</p>
</li>
</ul>
<h3 id="APP砸壳"><a href="#APP砸壳" class="headerlink" title="APP砸壳"></a>APP砸壳</h3><p>APP砸壳使用的工具</p>
<ul>
<li><p>Clutch</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Clutch - i // 获取加壳应用列表</span><br><span class="line">Clutch -d + 列表序号</span><br></pre></td></tr></table></figure>
</li>
<li><p>dumpdecrypted</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DYLD_INSERT_LIBRARIES=dumpdecrypted.dylib app</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>iOS12真的是对逆向不太友好，解决了各种kill 9之类的问题之后，你会发现上面的方法都砸壳失败了。最终使用<code>CrackerXI</code> 解决</p>
<h2 id="Clutch-解决iOS-12-中kill-9"><a href="#Clutch-解决iOS-12-中kill-9" class="headerlink" title="Clutch 解决iOS 12 中kill 9"></a>Clutch 解决iOS 12 中kill 9</h2><p>iOS12中似乎因为越狱不完美导致自己添加的可执行文件不受信任，报错kill: 9 ，其他可执行文件遇到kill 9 也可按照此方法尝试解决</p>
<p>可执行下面的代码添加信任</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> safe place to work <span class="keyword">in</span></span></span><br><span class="line">cd /private/var/mobile/Documents</span><br><span class="line"><span class="meta">#</span><span class="bash"> Get the ent from bash and save it</span></span><br><span class="line">ldid -e `which bash` &gt; ent.xml</span><br><span class="line"><span class="meta">#</span><span class="bash"> sign Clutch with the ent. <span class="string">"-Sent.xml"</span> is the correct usage</span></span><br><span class="line">ldid -Sent.xml `which Clutch`</span><br><span class="line"><span class="meta">#</span><span class="bash"> inject into trust cache</span></span><br><span class="line">inject `which Clutch`</span><br></pre></td></tr></table></figure>
<h2 id="Theos-使用"><a href="#Theos-使用" class="headerlink" title="Theos 使用"></a>Theos 使用</h2><h3 id="clone-theos"><a href="#clone-theos" class="headerlink" title="clone theos"></a>clone theos</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone --recursive https://github.com/theos/theos.git $THEOS</span><br></pre></td></tr></table></figure>
<h3 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// vim ~/.bash_profile</span><br><span class="line">export THEOS=~/theos</span><br><span class="line">export PATH=THEOS/bin:$PATH</span><br></pre></td></tr></table></figure>
<h3 id="编写tweak代码"><a href="#编写tweak代码" class="headerlink" title="编写tweak代码"></a>编写tweak代码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// 资源文件推荐路径 /Library/PreferenceLoader/Preferences/  </span><br><span class="line">// &quot;AAABBB&quot; &quot;CCCC&quot; 等价于 &quot;AAABBBCCCC&quot;</span><br><span class="line">// 宏定义中#会替换为”“</span><br><span class="line">#define YSFile(path) @&quot;/Library/PreferenceLoader/Preferences/YSWeChat/&quot; #path</span><br><span class="line"></span><br><span class="line">%hook PlayVideoController</span><br><span class="line"></span><br><span class="line">- (id)disableAdv &#123;</span><br><span class="line">	return true</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Always make sure you clean up after yourself; Not doing so could have grave consequences!</span><br><span class="line">%end</span><br></pre></td></tr></table></figure>
<h3 id="Logos语法"><a href="#Logos语法" class="headerlink" title="Logos语法"></a>Logos语法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">%hook %end // hook一个类的开始和结束</span><br><span class="line">%log //打印方法调用详情 -- 可在Xcode中查看日志</span><br><span class="line">HBDebugLog: 跟NSLog类似</span><br><span class="line">%ctor &#123;...&#125; // 在加载动态库时调用</span><br><span class="line">%dtor &#123;...&#125; // 在程序退出时调用</span><br><span class="line">%orig // 调用旧方法</span><br><span class="line">%new // 添加新方法  如果需要直接调用新声明的方法 需要在@interface中声明一下</span><br><span class="line">%c(className) // 等同于 NSClassFromString(@&quot;className&quot;)</span><br></pre></td></tr></table></figure>
<h3 id="logify-pl"><a href="#logify-pl" class="headerlink" title="logify.pl"></a>logify.pl</h3><p>可以将一个头文件快速转换成一家包含打印信息的xm文件</p>
<blockquote>
<p>logify.pl xx.h &gt; xx.xm<br>// 打印信息太多，可将%log 换成 NSStringFromSelector(_cmd)</p>
</blockquote>
<p>注意点：</p>
<ul>
<li><p>删掉__weak</p>
</li>
<li><p>删掉inout</p>
</li>
<li><p>删掉协议 比如<xxtestdelegate> 或声明协议 @protocol XXXDelegate, XXXXDelegate;</xxtestdelegate></p>
</li>
<li><p>删掉-(void).cxx_destruct{…}</p>
</li>
<li><p>删除HBLog(@”=0x%x,(unsigned int)r”)</p>
</li>
<li><p>替换类名为void, 比如将XXPerson <em>替换为void </em></p>
<ul>
<li>或者声明一下类信息@class XXPerson: NSObject;</li>
</ul>
</li>
</ul>
<h3 id="Makefile-配置环境变量"><a href="#Makefile-配置环境变量" class="headerlink" title="Makefile 配置环境变量"></a>Makefile 配置环境变量</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export THEOS_DEVICE_IP=127.0.0.1</span><br><span class="line">export THEOS_DEVICE_PORT=10010</span><br><span class="line"></span><br><span class="line">tweak_XXX_FILES = $(wildcard src/*/xm) // 编译文件</span><br></pre></td></tr></table></figure>
<h3 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make // 编译Tweak代码为动态库 *.dylib</span><br><span class="line">make package // 将dylib大包围deb文件  make package debug=0 打包release 版本</span><br><span class="line">make install // 将deb文件传送到手机上，通过Cydia安装</span><br></pre></td></tr></table></figure>
<p>插件将安装在/Library/MobileSubstrate/DynamicLibraries文件夹中</p>
<ul>
<li>*.dylib -&gt; 编译后的Tweak代码</li>
<li>*.plist -&gt; 存放着需要hooc的APP ID</li>
</ul>
<h1 id="iOS-命令行工具开发"><a href="#iOS-命令行工具开发" class="headerlink" title="iOS 命令行工具开发"></a>iOS 命令行工具开发</h1><h3 id="命令行工具的本质"><a href="#命令行工具的本质" class="headerlink" title="命令行工具的本质"></a>命令行工具的本质</h3><ul>
<li>可执行文件</li>
<li>和App内部可执行文件差不多</li>
</ul>
<h3 id="权限问题"><a href="#权限问题" class="headerlink" title="权限问题"></a>权限问题</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ldid -e TestCL &gt; TestCL.entitlements // 导出权限文件 &gt;覆盖 &gt;&gt; 追加 </span><br><span class="line">ldid -STestCL.entitlements TestCL // 导入权限文件 注意：-S后无空格</span><br></pre></td></tr></table></figure>
<h3 id="Xcode-调试"><a href="#Xcode-调试" class="headerlink" title="Xcode 调试"></a>Xcode 调试</h3><p>编译器发展历程： GCC-&gt;LLVM</p>
<p>调试器发展历程： GDB-&gt;LLDB</p>
<p>Debugserver 一开始在Xcode里，当手机连接Xcode时会安装到iPhone上</p>
<h2 id="动态调试任意APP"><a href="#动态调试任意APP" class="headerlink" title="动态调试任意APP"></a>动态调试任意APP</h2><h3 id="debugserver权限问题"><a href="#debugserver权限问题" class="headerlink" title="debugserver权限问题"></a>debugserver权限问题</h3><ul>
<li>默认情况下，/Developer/usr/bin/debugserver缺少一定的权限，只能调试Xcode安装的APP，无法调试其他APP（比如来自APP Store的APP）</li>
<li>如果希望调试其他APP，需要对debugserver重新签名，签上2个调试相关的权限<ul>
<li>get-task-allow</li>
<li>task_for_pid-allow</li>
</ul>
</li>
<li>将重签名的debugserver 放入 /usr/bin 目录</li>
</ul>
<p>签名方法：</p>
<ul>
<li>通过ldid签名</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ldid -Sdebugserver.entitlements debugserver</span></span><br></pre></td></tr></table></figure>
<ul>
<li>通过codesign签名</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看权限信息</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> codesign -d --entitlements - debugserver</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 签名权限</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> codesign -f -s - --entitlements debugserver.entitlements debugserver</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 或者简写为</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> codesing -fs- --entitlements debugserver.entitlements debugserver</span></span><br></pre></td></tr></table></figure>
<h3 id="让debugserver附加到某个APP进程"><a href="#让debugserver附加到某个APP进程" class="headerlink" title="让debugserver附加到某个APP进程"></a>让debugserver附加到某个APP进程</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> debugserver *:端口号 -a 进程</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> *:端口号  使用iPhone的某个端口启动debugserver服务 *标识主机地址</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -a 进程  输入APP的进程信息 (进程ID或进程名称)</span></span><br></pre></td></tr></table></figure>
<h3 id="调试方法"><a href="#调试方法" class="headerlink" title="调试方法"></a>调试方法</h3><ol>
<li>启动LLDB</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> lldb</span></span><br><span class="line">(lldb)</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>连接debugserver服务</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) process connect connect: //手机IP地址: debugserver服务端口号</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>使用LLDB的c命令让程序先继续执行</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) c</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>接下来就可以用LLDB命令调试APP了</li>
<li>退出连接</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) process detach</span><br></pre></td></tr></table></figure>
<p>常用的LLDB命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> debugserver -x auto *:端口号 APP的可执行文件路径</span></span><br></pre></td></tr></table></figure>
<h3 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h3><h4 id="lldb连接debugserver时报错-error-rejecting-incoming-connection-from-ffff-127-0-0-1-expecting-1"><a href="#lldb连接debugserver时报错-error-rejecting-incoming-connection-from-ffff-127-0-0-1-expecting-1" class="headerlink" title="lldb连接debugserver时报错 error: rejecting incoming connection from ::ffff:127.0.0.1 (expecting ::1)"></a>lldb连接debugserver时报错 error: rejecting incoming connection from ::ffff:127.0.0.1 (expecting ::1)</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sirde-iPhone:~ root# debugserver_arm64 *:10011 -a neteasemusic</span><br><span class="line"><span class="meta">debugserver-@(#</span><span class="bash">)PROGRAM:LLDB  PROJECT:lldb-900.3.87</span></span><br><span class="line"> for arm64.</span><br><span class="line">Attaching to process neteasemusic...</span><br><span class="line">Listening to port 10011 for a connection from *...</span><br><span class="line">error: rejecting incoming connection from ::ffff:127.0.0.1 (expecting ::1)</span><br></pre></td></tr></table></figure>
<p>解决办法</p>
<p>使用ip地址替换 * 和localhost</p>
<p>手机端：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sirde-iPhone:~ root# debugserver 127.0.0.1:10011 -a neteasemusic</span><br></pre></td></tr></table></figure>
<p>电脑端：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) process connect connect://127.0.0.1:10011</span><br></pre></td></tr></table></figure>
<h4 id="mac-lldb提示ImportError-cannot-import-name-remove-dead-weakref"><a href="#mac-lldb提示ImportError-cannot-import-name-remove-dead-weakref" class="headerlink" title="mac lldb提示ImportError: cannot import name _remove_dead_weakref"></a>mac lldb提示ImportError: cannot import name _remove_dead_weakref</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ lldb</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File "&lt;input&gt;", line 1, in &lt;module&gt;</span><br><span class="line">  File "/usr/local/Cellar/python@2/2.7.15_1/Frameworks/Python.framework/Versions/2.7/lib/python2.7/copy.py", line 52, in &lt;module&gt;</span><br><span class="line">    import weakref</span><br><span class="line">  File "/usr/local/Cellar/python@2/2.7.15_1/Frameworks/Python.framework/Versions/2.7/lib/python2.7/weakref.py", line 14, in &lt;module&gt;</span><br><span class="line">    from _weakref import (</span><br><span class="line">ImportError: cannot import name _remove_dead_weakref</span><br></pre></td></tr></table></figure>
<p>查看是否安装了python和python@2</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew list</span><br></pre></td></tr></table></figure>
<p>remove 多余的 python@2</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew remove python@2 --ignore-dependencies</span><br></pre></td></tr></table></figure>
<h3 id="debugserver-在-iOS-12遇到的坑"><a href="#debugserver-在-iOS-12遇到的坑" class="headerlink" title="debugserver 在 iOS 12遇到的坑"></a>debugserver 在 iOS 12遇到的坑</h3><p>因iOS12为不完美越狱，开发中总会遇到各种困难 kill:9，可通过如下方法解决</p>
<ol>
<li><p>从/Developer/usr/bin/debugserver取出debugserver (或使用其他工具复制到电脑)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp /Developer/usr/bin/debugserver  /var/root/</span><br><span class="line">scp root@ip:/var/root/debugserver ./</span><br></pre></td></tr></table></figure>
</li>
<li><p>对debugserver进行瘦身，抽取arm64架构二进制文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lipo -thin arm64 debugserver  -output debugserver_arm64</span><br></pre></td></tr></table></figure>
</li>
<li><p>复制debugserver_arm64到手机usr/bin目录 (可使用其他工具复制)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp debugserver_arm64 root@ip:/usr/bin/debugserver_arm64</span><br></pre></td></tr></table></figure>
</li>
<li><p>用ldid对debugserver进行签名 (也可在在电脑中签名后复制到手机)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// uncOver越狱会提供debugserver.xml在/usr/share/entitlements/debugserver.xml</span><br><span class="line">ldid -S/usr/share/entitlements/debugserver.xml /usr/bin/debugserver_arm64</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用inject命令 (貌似是添加信任)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inject /usr/bin/debugserver_arm64</span><br></pre></td></tr></table></figure></li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/17/Block/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ysir">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YSir's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/17/Block/" itemprop="url">Block</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-12-17T14:43:35+08:00">
                2019-12-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Block"><a href="#Block" class="headerlink" title="Block"></a>Block</h1><p>Block本质是一个NSBlock类型的OC对象</p>
<h3 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">// eg:</span><br><span class="line">// int someVar = 20</span><br><span class="line">// void (^block)(void) = ^&#123;</span><br><span class="line">//	NSLog(&quot;var is %d&quot;, age);</span><br><span class="line">//&#125;</span><br><span class="line">// block();</span><br><span class="line"></span><br><span class="line">struct __mainblock_impl_0 &#123;-</span><br><span class="line">  struct __blockimpl impl; // 见下方__block_impl</span><br><span class="line">  struct __main_block_desc_0* Desc; // 见下方__main_block_desc_0</span><br><span class="line">  int someVar; // 捕获的变量</span><br><span class="line">  </span><br><span class="line">  // 构造函数，返回结构体对象</span><br><span class="line">  __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int flags=0) &#123;</span><br><span class="line">    impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct __block_impl &#123;</span><br><span class="line">  void *isa;</span><br><span class="line">  int Flags;</span><br><span class="line">  int Reserved;</span><br><span class="line">  void *FuncPtr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static struct __main_block_desc_0 &#123;</span><br><span class="line">  size_t reserved; </span><br><span class="line">  size_t Block_size; // Block的大小</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; 0, sizeof(struct __main_block_impl_0)&#125;; // 在这里计算了Block的大小</span><br><span class="line"></span><br><span class="line">// 封装了block执行逻辑的函数</span><br><span class="line">static void __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;</span><br><span class="line">	// 这里是block内部的代码</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 执行block的代码 (已经经过简化)</span><br><span class="line">block-&gt;FuncPtr(block);</span><br></pre></td></tr></table></figure>
<h3 id="变量的捕获-capture"><a href="#变量的捕获-capture" class="headerlink" title="变量的捕获(capture)"></a>变量的捕获(capture)</h3><ul>
<li>局部变量<ul>
<li>auto  (捕获, 值传递)</li>
<li>static (捕获, 指针传递)</li>
</ul>
</li>
<li>全局变量 (不捕获, 直接访问)</li>
</ul>
<h3 id="Block的类型"><a href="#Block的类型" class="headerlink" title="Block的类型"></a>Block的类型</h3><p>Block有3种类型，可以通过class方法或者isa指针查看具体类型，最终都是继承自NSBlock类型</p>
<ul>
<li><strong>__NSGlobalBlock__(_NSConcreteGlobalBlock)</strong>  -&gt; 数据区(.data)<ul>
<li>没有访问auto变量</li>
</ul>
</li>
<li><strong>__NSStackBlock__(_NSConcreteStackBlock)</strong>  -&gt; 堆<ul>
<li>访问了auto变量</li>
</ul>
</li>
<li><strong>__NSConcreteStackBlock__(_NSConcreteMallocBlock)</strong> -&gt; 栈<ul>
<li>__NSStackBlock__调用了copy</li>
</ul>
</li>
</ul>
<h3 id="Block的copy"><a href="#Block的copy" class="headerlink" title="Block的copy"></a>Block的copy</h3><p>在<strong>ARC</strong>环境下，编译器会自动将栈上的block复制到堆上，比如如下情况</p>
<ul>
<li>block作为函数返回值时</li>
<li>将block赋值给__strong指针时</li>
<li>block作为Cocoa API中方法名含有usingBlock的方法参数时</li>
<li>block作为GCD的方法参数</li>
</ul>
<h3 id="对象类型的auto变量"><a href="#对象类型的auto变量" class="headerlink" title="对象类型的auto变量"></a>对象类型的auto变量</h3><p>当block内部访问了对象类型的auto变量时</p>
<ul>
<li>如果block是在栈上，将不会对auto变量产生强引用</li>
<li>如果block被拷贝到堆上<ul>
<li>会调用block内部的copy函数</li>
<li>copy函数内部会调用_Block_object_assign函数</li>
<li>_Block_object_assign函数会根据auto变量的修饰符(__strong、__weak、__unsafe_unretained)做出相应的操作，类似retain(形成强引用、弱引用)</li>
</ul>
</li>
<li>如果block从堆上移除<ul>
<li>会调用block内部的dispose函数</li>
<li>dispose函数内部会调用_Block_object_dispose函数</li>
<li>_Block_object_dispose函数会自动释放引用的auto变量，类似release</li>
</ul>
</li>
</ul>
<h3 id="block修饰符"><a href="#block修饰符" class="headerlink" title="__block修饰符"></a>__block修饰符</h3><p>__block可以用于解决block内部无法修改auto变量值的问题</p>
<p>__block不能修饰静态变量(static)、全局变量</p>
<p>编辑器会将__block变量包装成一个对象</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">__block <span class="keyword">int</span> age = <span class="number">10</span>;</span><br><span class="line">^&#123;</span><br><span class="line">  NSlog(@<span class="string">"%d"</span>, age);</span><br><span class="line">&#125;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// block对象编译成的结构体</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">main_block_impl_0</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> __<span class="title">block_impl</span> <span class="title">impl</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> __<span class="title">main_block_desc_0</span>* <span class="title">Desc</span>;</span></span><br><span class="line">	__Block_byref_age_0 *age; <span class="comment">// int age 包装的对象</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//  生成的age对象对应的结构体</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">Block_byref_age_0</span> &#123;</span></span><br><span class="line">	<span class="keyword">void</span> *__isa;</span><br><span class="line">	__Block_byref_age_0 *__forwarding; <span class="comment">// 指向自己，用于指向堆上的对象copy</span></span><br><span class="line">	<span class="keyword">int</span> __flags;</span><br><span class="line">	<span class="keyword">int</span> __size;</span><br><span class="line">	<span class="keyword">int</span> age;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/16/编译C++文件/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ysir">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YSir's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/16/编译C++文件/" itemprop="url">编译C++文件</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-12-16T18:27:15+08:00">
                2019-12-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="编译C-文件"><a href="#编译C-文件" class="headerlink" title="编译C++文件"></a>编译C++文件</h1><p>编译c++文件有助于帮助分析OC文件的底层实现</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 将.m文件编译成c++代码</span><br><span class="line">xcrun -skd iphoneos clang -arch arm64 -rewrite-objc main.m</span><br></pre></td></tr></table></figure>
<p>如果遇到__weak编译报错 (cannot create __weak reference in file using manual reference)</p>
<p>解决方案: 支持ARC、指定运行时系统版本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcrun -skd iphoneos clang -arch arm64 -rewrite-objc -fobjc-arc -fobjc-runtime=ios-8.0.0 main.m</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/09/load 和 initialize/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ysir">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YSir's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/09/load 和 initialize/" itemprop="url">load 和 initialize</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-12-09T18:37:24+08:00">
                2019-12-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="load-和-initialize"><a href="#load-和-initialize" class="headerlink" title="load 和 initialize"></a>load 和 initialize</h1><h2 id="Load"><a href="#Load" class="headerlink" title="Load"></a>Load</h2><h3 id="调用顺序"><a href="#调用顺序" class="headerlink" title="调用顺序"></a>调用顺序</h3><ol>
<li>先调用类的+load方法（多个类的+load方法按照编译的顺序，先编译先调用）</li>
<li>调用子类的+load之前会先调用父类的+load</li>
<li>再调用分类的+load方法（多个分类的+load方法按照编译的顺序，先编译先调用）</li>
</ol>
<h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><ol>
<li>+load方法会在runtime加载类、分类时调用</li>
<li>每个类、分类的+load，在程序运行过程中只调用一次</li>
<li>+load是根据方法地址直接调用，不经过objc_msgSend函数调用</li>
</ol>
<h2 id="initialize"><a href="#initialize" class="headerlink" title="initialize"></a>initialize</h2><p>objc-runtime-new.mm</p>
<p>class_getInstanceMethod</p>
<p>lookUp</p>
<h3 id="调用顺序-1"><a href="#调用顺序-1" class="headerlink" title="调用顺序"></a>调用顺序</h3><p>先调用父类的+initialize，再调用子类的+initialize </p>
<blockquote>
<p>递归查找父类的+initialize方法</p>
</blockquote>
<h3 id="特点-1"><a href="#特点-1" class="headerlink" title="特点"></a>特点</h3><ol>
<li>+initialize是通过objc_msgSend进行调用的</li>
<li>如果子类没有实现+initialize,会调用父类的+initialize（所以父类的+initialize可能会被调用多次）</li>
<li>如果分类实现了+initialize,会覆盖类本身的+initialize调用</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/04/LLDB 动态调试/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ysir">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YSir's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/04/LLDB 动态调试/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-12-04T15:57:19+08:00">
                2019-12-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>​—<br>title: LLDB 动态调试任意APP<br>tags: iOS<br>​—</p>
<h2 id="LLDB-动态调试任意APP"><a href="#LLDB-动态调试任意APP" class="headerlink" title="LLDB 动态调试任意APP"></a>LLDB 动态调试任意APP</h2><h3 id="debugserver权限问题"><a href="#debugserver权限问题" class="headerlink" title="debugserver权限问题"></a>debugserver权限问题</h3><ul>
<li>默认情况下，/Developer/usr/bin/debugserver缺少一定的权限，只能调试Xcode安装的APP，无法调试其他APP（比如来自APP Store的APP）</li>
<li>如果希望调试其他APP，需要对debugserver重新签名，签上2个调试相关的权限<ul>
<li>get-task-allow</li>
<li>task_for_pid-allow</li>
</ul>
</li>
<li>将重签名的debugserver 放入 /usr/bin 目录</li>
</ul>
<p>签名方法：</p>
<ul>
<li>通过ldid签名</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ldid -Sdebugserver.entitlements debugserver</span></span><br></pre></td></tr></table></figure>
<ul>
<li>通过codesign签名</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看权限信息</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> codesign -d --entitlements - debugserver</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 签名权限</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> codesign -f -s - --entitlements debugserver.entitlements debugserver</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 或者简写为</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> codesing -fs- --entitlements debugserver.entitlements debugserver</span></span><br></pre></td></tr></table></figure>
<h3 id="让debugserver附加到某个APP进程"><a href="#让debugserver附加到某个APP进程" class="headerlink" title="让debugserver附加到某个APP进程"></a>让debugserver附加到某个APP进程</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> debugserver *:端口号 -a 进程</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> *:端口号  使用iPhone的某个端口启动debugserver服务 *标识主机地址</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -a 进程  输入APP的进程信息 (进程ID或进程名称)</span></span><br></pre></td></tr></table></figure>
<h3 id="调试方法"><a href="#调试方法" class="headerlink" title="调试方法"></a>调试方法</h3><ol>
<li>启动LLDB</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> lldb</span></span><br><span class="line">(lldb)</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>连接debugserver服务</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) process connect connect: //手机IP地址: debugserver服务端口号</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>使用LLDB的c命令让程序先继续执行</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) c</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>接下来就可以用LLDB命令调试APP了</li>
<li>退出连接</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) process detach</span><br></pre></td></tr></table></figure>
<p>通过debugserver启动APP</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> debugserver -x auto *:端口号 APP的可执行文件路径</span></span><br></pre></td></tr></table></figure>
<h2 id="LLDB-用法"><a href="#LLDB-用法" class="headerlink" title="LLDB 用法"></a>LLDB 用法</h2><h4 id="指令的格式"><a href="#指令的格式" class="headerlink" title="指令的格式"></a>指令的格式</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> &lt;<span class="built_in">command</span>&gt;: 命令</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> &lt;subcommand&gt;: 子命令</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> &lt;action&gt;: 命令操作</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> &lt;options&gt;: 命令选项</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> &lt;arguments&gt;: 命令参数</span></span><br><span class="line">&lt;command&gt; [&lt;subcommand&gt; [&lt;subcommand&gt;]] &lt;action&gt; [-option [option-value]] [argument [argument...]]</span><br></pre></td></tr></table></figure>
<p>比如给test函数设置断点</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">breakpoint set -n test </span><br><span class="line"><span class="meta">#</span><span class="bash"> breakpoint -- &lt;<span class="built_in">command</span>&gt;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">set</span> -- &lt;action&gt;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -n -- &lt;options&gt;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">test</span> -- &lt;arguments&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="常用LLDB命令"><a href="#常用LLDB命令" class="headerlink" title="常用LLDB命令"></a>常用LLDB命令</h4><ul>
<li><strong>help</strong></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">help + &lt;command&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">help</span> breakpoint</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>expression</strong></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">expression &lt;cmd-options&gt;--&lt;expr&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 执行一个表达式</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> &lt;cmd-options&gt;: 命令选项</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -- 命令选项结束符,标识所有的命令已经设置完毕，如果没有命令选项，--可以省略</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> &lt;expr&gt;: 需要执行的表达式</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> eg:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> expression self.view.backgroundColor = [UIColor redColor]</span></span><br></pre></td></tr></table></figure>
<p>注：</p>
<blockquote>
<p> <code>expression</code>、<code>expression —</code>和指令<code>print</code>、<code>p</code>、<code>call</code>的效果一样</p>
</blockquote>
<blockquote>
<p><code>expression、-O —</code> 和指令<code>po</code>效果一样</p>
</blockquote>
<blockquote>
<p><code>po $寄存器</code> 可直接打印寄存器地址指向的内容</p>
</blockquote>
<blockquote>
<p>x/&lt;类型&gt; 地址 可读取内存内容 eg:<code>x/s $x1</code> 可读取x1寄存器的字符串</p>
</blockquote>
<ul>
<li><p><strong>Thread backtrack</strong></p>
<p>打印线程的堆栈信息</p>
<p>和指令bt的效果一样</p>
</li>
<li><p><strong>thread return <expr></expr></strong></p>
<p>让函数直接返回某个值，不会执行断点后面的代码</p>
</li>
<li><p><strong>frame variable [<variable-name>]</variable-name></strong></p>
<p>打印当前栈帧的变量</p>
</li>
<li><p><strong>thread continue、c</strong> : 程序继续执行</p>
</li>
<li><p><strong>thread step-over、next、n</strong> : 单步运行，把子函数当做整体一步执行</p>
</li>
<li><p><strong>thread step-in、step、s</strong> :  单步运行，遇到子函数会进入子函数</p>
</li>
<li><p><strong>thread step-out、finish</strong> :直接执行完当前函数所有代码，返回上一个函数</p>
</li>
<li><p><strong>si、ni和s、n类似</strong> </p>
<p>thread step-inst-over、nexti、ni</p>
<p>Thread step-inset、stepi、si</p>
<p>s、n是源码级别</p>
<p>si、ni是汇编指令级别</p>
</li>
<li><p><strong>breakpoint set</strong> </p>
<ul>
<li>breakpoint set -a 函数地址</li>
<li>breakpoint set -n 函数名 （注：调试第三方程序时不能使用函数名打断点）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">breakpoint set -n test</span><br><span class="line">breakpoint set -n touchesBegan:withEvent:</span><br><span class="line">breakpoint set -n "-[ViewController touchesBegan:withEvent:]"</span><br></pre></td></tr></table></figure>
<ul>
<li>breakpoint set -r 正则表达式</li>
<li>breakpoint set -s 动态库 -n 函数名</li>
</ul>
</li>
<li><p><strong>breakpoint list</strong> : 列出所有的断点(每个断点都有自己的编号)</p>
</li>
<li><p><strong>breakpoint disable 断点编号</strong> 禁用断点</p>
</li>
<li><p><strong>breakpoint enable 断点编号</strong> 启用断点</p>
</li>
<li><p><strong>breakpoint delete 断点编号</strong> 删除断点</p>
</li>
<li><p><strong>breakpoint command add 断点编号</strong> 给断点预习设置需要执行的命令，到触发断点时，就会按顺序执行</p>
</li>
<li><p><strong>breakpoint command list 断点编号</strong> 查看某个断点设置的命令</p>
</li>
<li><p><strong>breakpoint  command delete 断点编号</strong> 删除某个断点设置的命令</p>
</li>
<li><p><strong>内存断点</strong></p>
<ul>
<li><p>在内存数据发生改变的时候触发</p>
</li>
<li><p>watchpoint set variable 变量</p>
<p><code>watchpoint set variable self-&gt;age</code></p>
</li>
<li><p>watchpoint set expression 地址</p>
<p><code>watchpoint set expression &amp;(self-&gt;age)</code></p>
</li>
<li><p>watchpoint list</p>
</li>
<li><p>watchpoint disable 断点编号</p>
</li>
<li><p>watchpoint enable 断点编号</p>
</li>
<li><p>watchpoint delete 断点编号</p>
</li>
<li><p>watchpoint command add 断点编号</p>
</li>
<li><p>watchpoint command list 断点编号</p>
</li>
<li><p>watchpoint command delete 断点编号</p>
</li>
</ul>
</li>
<li><p><strong>image lookup</strong></p>
<ul>
<li>image lookup -t 类型： 查找某个类型的信息</li>
<li>image lookup -a 地址： 根据内存地址查找在模块中的位置</li>
<li>Image lookup -n 符号或者函数名： 查找某个符号或者函数的位置</li>
</ul>
</li>
<li><p><strong>image list</strong></p>
<p>列出所加载的模块信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">image list -o -f # 打印出模块的偏移地址、全路径</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>memory read</strong></p>
<p>读取所有寄存器的值</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> memory <span class="built_in">read</span>/[数量][格式][字节数] [内存地址]</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> x/[数量][格式][字节数] [内存地址]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 格式: x-&gt;16进制; d-&gt;10进制; f-&gt;浮点数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 字节大小: b-&gt;byte 1字节; h-&gt;half word 2字节; w-&gt;word 4字节; g-&gt;giant word 8字节</span></span><br><span class="line">x/3xw 0x10010</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p><strong>memory write</strong> 寄存器 值</p>
<p>给某个寄存器写入值</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> memory write [内存地址] [数值]</span></span><br><span class="line">memory write 0x0000010 10</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>po $x0</strong> 打印方法调用者</p>
</li>
<li><p><strong>x/s $x1</strong> 打印方法名</p>
</li>
<li><p><strong>po $x2</strong> 打印参数 (以此类推，x3,x4也可能是参数)</p>
<blockquote>
<p>如果是非arm64, 寄存器就是r0,r1,r2</p>
</blockquote>
</li>
<li><p><strong>小技巧</strong></p>
<ul>
<li>敲Enter，会自动执行上次的命令</li>
<li>绝大多数命令都可以使用缩写</li>
</ul>
</li>
</ul>
<h3 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h3><h4 id="lldb连接debugserver时报错-error-rejecting-incoming-connection-from-ffff-127-0-0-1-expecting-1"><a href="#lldb连接debugserver时报错-error-rejecting-incoming-connection-from-ffff-127-0-0-1-expecting-1" class="headerlink" title="lldb连接debugserver时报错 error: rejecting incoming connection from ::ffff:127.0.0.1 (expecting ::1)"></a>lldb连接debugserver时报错 error: rejecting incoming connection from ::ffff:127.0.0.1 (expecting ::1)</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sirde-iPhone:~ root# debugserver_arm64 *:10011 -a neteasemusic</span><br><span class="line"><span class="meta">debugserver-@(#</span><span class="bash">)PROGRAM:LLDB  PROJECT:lldb-900.3.87</span></span><br><span class="line"> for arm64.</span><br><span class="line">Attaching to process neteasemusic...</span><br><span class="line">Listening to port 10011 for a connection from *...</span><br><span class="line">error: rejecting incoming connection from ::ffff:127.0.0.1 (expecting ::1)</span><br></pre></td></tr></table></figure>
<p>解决办法</p>
<p>使用ip地址替换 * 和localhost</p>
<p>手机端：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sirde-iPhone:~ root# debugserver 127.0.0.1:10011 -a neteasemusic</span><br></pre></td></tr></table></figure>
<p>电脑端：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) process connect connect://127.0.0.1:10011</span><br></pre></td></tr></table></figure>
<h4 id="mac-lldb提示ImportError-cannot-import-name-remove-dead-weakref"><a href="#mac-lldb提示ImportError-cannot-import-name-remove-dead-weakref" class="headerlink" title="mac lldb提示ImportError: cannot import name _remove_dead_weakref"></a>mac lldb提示ImportError: cannot import name _remove_dead_weakref</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ lldb</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File "&lt;input&gt;", line 1, in &lt;module&gt;</span><br><span class="line">  File "/usr/local/Cellar/python@2/2.7.15_1/Frameworks/Python.framework/Versions/2.7/lib/python2.7/copy.py", line 52, in &lt;module&gt;</span><br><span class="line">    import weakref</span><br><span class="line">  File "/usr/local/Cellar/python@2/2.7.15_1/Frameworks/Python.framework/Versions/2.7/lib/python2.7/weakref.py", line 14, in &lt;module&gt;</span><br><span class="line">    from _weakref import (</span><br><span class="line">ImportError: cannot import name _remove_dead_weakref</span><br></pre></td></tr></table></figure>
<p>查看是否安装了python和python@2</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew list</span><br></pre></td></tr></table></figure>
<p>remove 多余的 python@2</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew remove python@2 --ignore-dependencies</span><br></pre></td></tr></table></figure>
<h3 id="debugserver-在-iOS-12遇到的坑"><a href="#debugserver-在-iOS-12遇到的坑" class="headerlink" title="debugserver 在 iOS 12遇到的坑"></a>debugserver 在 iOS 12遇到的坑</h3><p>因iOS12为不完美越狱，开发中总会遇到各种困难 kill:9，可通过如下方法解决</p>
<ol>
<li><p>从/Developer/usr/bin/debugserver取出debugserver (或使用其他工具复制到电脑)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp /Developer/usr/bin/debugserver  /var/root/</span><br><span class="line">scp root@ip:/var/root/debugserver ./</span><br></pre></td></tr></table></figure>
</li>
<li><p>对debugserver进行瘦身，抽取arm64架构二进制文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lipo -thin arm64 debugserver  -output debugserver_arm64</span><br></pre></td></tr></table></figure>
</li>
<li><p>复制debugserver_arm64到手机usr/bin目录 (可使用其他工具复制)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp debugserver_arm64 root@ip:/usr/bin/debugserver_arm64</span><br></pre></td></tr></table></figure>
</li>
<li><p>用ldid对debugserver进行签名 (也可在在电脑中签名后复制到手机)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// uncOver越狱会提供debugserver.xml在/usr/share/entitlements/debugserver.xml</span><br><span class="line">ldid -S/usr/share/entitlements/debugserver.xml /usr/bin/debugserver_arm64</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用inject命令 (貌似是添加信任)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inject /usr/bin/debugserver_arm64</span><br></pre></td></tr></table></figure>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/31/LLVM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ysir">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YSir's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/31/LLVM/" itemprop="url">LLVM</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-31T14:33:24+08:00">
                2019-10-31
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="LLVM"><a href="#LLVM" class="headerlink" title="LLVM"></a>LLVM</h1><p>LLVM是项目模块化，可重用的编译器及工具链技术的集合</p>
<h3 id="传统编译器的架构"><a href="#传统编译器的架构" class="headerlink" title="传统编译器的架构"></a>传统编译器的架构</h3><ul>
<li><p>Front: 前端</p>
<p>词法分析、语法分析、语义分析、将不同语言生成中间代码</p>
</li>
<li><p>Optimizer: 优化器</p>
<p>中间代码优化</p>
</li>
<li><p>Backend: 后端</p>
<p>针对不同架构生成机器码</p>
</li>
</ul>
<h3 id="LLVM架构"><a href="#LLVM架构" class="headerlink" title="LLVM架构"></a>LLVM架构</h3><p>前后端不耦合，不同的前端后端，使用同一的中间代码 LLVM Intermediate Representation (LLVM IR)</p>
<ul>
<li>如果需要支持一种新的编程语言，那么只需要实现一个新的前端</li>
<li>如果需要支持一种新的硬件设备，那么只需要实现一个新的后端</li>
<li>优化阶段是一个通用的阶段，它针对的是统一的LLVM IR，不论是支持新的编程语言，还是支持新的硬件设备，都不需要对优化阶段做修改</li>
<li>相比之下，GCC的前端后端耦合，所以GCC为了支持一门新的语言或者新的设备，就变得特别困难</li>
<li>LLVM现在被作为实现各种静态和运行时编译语言的通用基础结构(GCC家族、JAVA、.NET、Python、Ruby、Scheme、Haskell等)</li>
</ul>
<h3 id="什么是Clang"><a href="#什么是Clang" class="headerlink" title="什么是Clang"></a>什么是Clang</h3><ul>
<li>LLVM项目的一个子项目</li>
<li>基于LLVM架构的C/C++/Objective-C编译器前端</li>
</ul>
<p><strong>相比于GCC, Clang具有如下优点</strong></p>
<ul>
<li>编译速度快： 在某些平台上</li>
<li>Clang采用基于库的模块化设计，易于IDE集成及其他用途的重用</li>
<li>诊断信息可读性强：在编译过程中，Clang创建并保留了大量详细的元数据，有利于调试和错误分析</li>
<li>设计清晰简单，易于扩展增强</li>
</ul>
<h2 id="OC源文件的编译过程"><a href="#OC源文件的编译过程" class="headerlink" title="OC源文件的编译过程"></a>OC源文件的编译过程</h2><p>命令行查看编译过程</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> clang -ccc-print-phases main.m</span><br><span class="line"></span><br><span class="line">0: input, "main.m", objective-c</span><br><span class="line">1: preprocessor, &#123;0&#125;, objective-c-cpp-output  # 预处理器 include import 替换宏</span><br><span class="line">2: compiler, &#123;1&#125;, ir                          # 编译成中间代码</span><br><span class="line">3: backend, &#123;2&#125;, assembler                    # 汇编</span><br><span class="line">4: assembler, &#123;3&#125;, object</span><br><span class="line">5: linker, &#123;4&#125;, image													# 链接</span><br><span class="line">6: bind-arch, "x86_64", &#123;5&#125;, image						# 生成针对架构的代码</span><br></pre></td></tr></table></figure>
<p>查看预处理结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> clang -e main.m</span><br></pre></td></tr></table></figure>
<p>词法分析，生成token</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> clang -fmodules -E -Xclang -dump-tokens main.m</span><br><span class="line"></span><br><span class="line">annot_module_include '#include &lt;s'		Loc=&lt;main.m:1:1&gt;</span><br><span class="line">void 'void'		Loc=&lt;main.m:2:1&gt;</span><br><span class="line">identifier 'main'	 [LeadingSpace]	Loc=&lt;main.m:2:6&gt;</span><br><span class="line">l_paren '('		Loc=&lt;main.m:2:10&gt;</span><br><span class="line">r_paren ')'		Loc=&lt;main.m:2:11&gt;</span><br><span class="line">l_brace '&#123;'	 [LeadingSpace]	Loc=&lt;main.m:2:13&gt;</span><br><span class="line">return 'return'	 [StartOfLine] [LeadingSpace]	Loc=&lt;main.m:3:3&gt;</span><br><span class="line">numeric_constant '0'	 [LeadingSpace]	Loc=&lt;main.m:3:10&gt;</span><br><span class="line">semi ';'		Loc=&lt;main.m:3:11&gt;</span><br><span class="line">r_brace '&#125;'	 [StartOfLine]	Loc=&lt;main.m:4:1&gt;</span><br><span class="line">eof ''		Loc=&lt;main.m:4:2&gt;</span><br></pre></td></tr></table></figure>
<p>语法分析，生成语法书(AST, Abstract Syntax Tree)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> clang -fmodules -fsyntax-only -Xclang -ast-dump main.m</span><br></pre></td></tr></table></figure>
<p>生成中间代码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> LLVM IR 有3种格式</span><br><span class="line"><span class="meta">#</span> 1.text 便于阅读的格式，类似汇编语言，拓展名.ll</span><br><span class="line"><span class="meta">$</span> clang -S -emit-llvm main.m</span><br><span class="line"><span class="meta">#</span> 2.内存格式</span><br><span class="line"><span class="meta">#</span> 3.bitcode: 二进制格式，拓展名.bc</span><br><span class="line"><span class="meta">$</span> clang -c -emit-llvm main.m</span><br></pre></td></tr></table></figure>
<h3 id="源码下载"><a href="#源码下载" class="headerlink" title="源码下载"></a>源码下载</h3><ul>
<li>下载LLVM</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> git clone https://git.llvm.org/git/llvm.git/</span><br></pre></td></tr></table></figure>
<ul>
<li>下载clang</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> cd llvm/tools</span><br><span class="line"><span class="meta">$</span> git clone https://git.llvm.org/git/clang.git/</span><br></pre></td></tr></table></figure>
<h3 id="源码编译"><a href="#源码编译" class="headerlink" title="源码编译"></a>源码编译</h3><ul>
<li>安装cmake和ninja（先安装brew, <a href="https://brew.sh/）" target="_blank" rel="noopener">https://brew.sh/）</a></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> brew install cmake</span><br><span class="line"><span class="meta">$</span> brew install ninja</span><br></pre></td></tr></table></figure>
<ul>
<li><p>ninja如果安装失败，可以直接从github获取release版放入<code>/usr/local/bin</code></p>
<blockquote>
<p><a href="https://github.com/ninja-build/ninja/releases" target="_blank" rel="noopener">https://github.com/ninja-build/ninja/releases</a></p>
</blockquote>
</li>
<li><p>在LLVM源码统计目录下新建一个llvm_build目录，最终在llvm_build目录下生成<code>build.ninja</code></p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> cd llvm_build</span><br><span class="line"><span class="meta">$</span> cmake -G Ninja ../llvm -DCMAKE_INSTALL_PREFIX=LLVM的安装路径  # llvm_release</span><br><span class="line"><span class="meta">#</span> 更多cmake相关选项，可以参考 https://llvm.org/docs/CMake.html</span><br></pre></td></tr></table></figure>
<ul>
<li>依次执行编译、安装指令</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> ninja  # 在llvm_build 目录</span><br><span class="line"><span class="meta">#</span> 编译完毕后 llvm_build 目录大概21.05G</span><br><span class="line"><span class="meta">$</span> ninja install</span><br><span class="line"><span class="meta">#</span> 安装完毕后，安装目录大概11.92G</span><br></pre></td></tr></table></figure>
<h3 id="LLVM-应用"><a href="#LLVM-应用" class="headerlink" title="LLVM 应用"></a>LLVM 应用</h3><ul>
<li><p>libclang、libTooling </p>
<p>应用： 语法树分析、语言转换</p>
<blockquote>
<p><a href="https://clang.llvm.org/docs/Tooling.html" target="_blank" rel="noopener">https://clang.llvm.org/docs/Tooling.html</a></p>
</blockquote>
</li>
<li><p>Clang插件开发</p>
<p>应用：代码检查(命名规范、代码规范)等</p>
<blockquote>
<p><a href="https://clang.llvm.org/docs/ClangPlugins.html" target="_blank" rel="noopener">https://clang.llvm.org/docs/ClangPlugins.html</a><br><a href="https://clang.llvm.org/docs/ExternalClangExamples.html" target="_blank" rel="noopener">https://clang.llvm.org/docs/ExternalClangExamples.html</a><br><a href="https://clang.llvm.org/docs/RAVFrontendAction.html" target="_blank" rel="noopener">https://clang.llvm.org/docs/RAVFrontendAction.html</a></p>
</blockquote>
</li>
<li><p>Pass开发</p>
<p>应用： 代码优化、代码混淆</p>
<blockquote>
<p><a href="https://llvm.org/docs/WritingAnLLVMPass.html" target="_blank" rel="noopener">https://llvm.org/docs/WritingAnLLVMPass.html</a></p>
</blockquote>
</li>
<li><p>开发新的编程语言</p>
<blockquote>
<p><a href="https://llvm-tutorial-cn.readthedocs.io/en/latest/index.html" target="_blank" rel="noopener">https://llvm-tutorial-cn.readthedocs.io/en/latest/index.html</a><br><a href="https://kaleidoscope-llvm-tutorial-zh-cn.readthedocs.io/zh_CN/latest/" target="_blank" rel="noopener">https://kaleidoscope-llvm-tutorial-zh-cn.readthedocs.io/zh_CN/latest/</a></p>
</blockquote>
</li>
</ul>
<h3 id="clang插件开发"><a href="#clang插件开发" class="headerlink" title="clang插件开发"></a>clang插件开发</h3><ul>
<li><p>加载插件</p>
<p>在Xcode项目中指定加载插件动态库：Build Setting &gt; OTHER_CFLAGS</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Xclang -load -Xclang 动态库路径 -Xclang -add - plugin -Xclang 插件名称</span><br></pre></td></tr></table></figure>
<ul>
<li>Hack Xcode</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="ysir">
          <p class="site-author-name" itemprop="name">ysir</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">35</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">tags</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ysir</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
